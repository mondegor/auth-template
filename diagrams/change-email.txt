# Изменение емаила пользователя в отложенном режиме с его предварительным подтверждением

```plantuml
@startuml
!theme mars

skinparam {
    MaxMessageSize 250
}

skinparam sequence {
    ParticipantPadding 125
    MessageAlign center
}

participant "EmailClient" as eml order 10
participant "User" as usr order 20
participant "WebApp" as app order 30
participant "Auth" as auth order 40
participant "MailSender" as ms order 50

usr -> app: Заполнение формы регистрации, нажатие кнопки "Зарегистрироваться"
app -> auth: [Auth/CH/R4] Запрос на изменение емаила пользователя
auth -> auth: Первичная обработка запроса
app <-- auth: [Auth/CH/R4] Success 202 + OperationToken

app -> app: Отображение формы с полем для ввода кода подтверждения

auth -> auth: Генерация кода подтверждения

auth --> ms: Отправка события о необходимости отправки кода подтверждения
auth -> auth: Постановка запроса в очередь в ожидании подтверждения от пользователя
ms --> eml: Отправляется письмо с кодом подтверждения
usr <-- eml: Получение на почте письма с кодом подтверждения

usr -> app: Вводит полученный код подтверждения
app -> auth: [Auth/OP/R2] Запрос на подтверждение емаила + OperationToken
auth -> auth: Измененение статуса емаила с "CONFIRMING" на "UPDATING"
app <-- auth: [Auth/OP/R2] Success 204

alt #f0fff0 Прошло N дней после подтверждения запроса на обновление емаила
  auth -> auth: замена старого емаила аккаунта на новый
else #fff0f0 Пользователь решил отменить операцию обновления емаила
  app -> auth: [Auth/R3] Запрос на получение информации об аккаунте
  app <-- auth: [Auth/R3] Success 200 + OperationToken

  usr -> app: Отменяет операцию обновления емаила
  app -> auth: [Auth/OP/R3] Запрос на отмену обновления емаила + OperationToken
  app <-- auth: [Auth/OP/R3] Success 204
end

@enduml
```